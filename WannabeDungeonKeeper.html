<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Wannabe Dungeon Keeper</title>
<script type="text/javascript" src="phaser.min.js"> </script>

<style type="text/css">

body{
	background-color:#00F;
	}
h1{
	text-align:center;
	size:24px;
	color:#000;	
	}
#Game{
	margin-left:auto;
	margin-right:auto;
	width:800px;
	}

</style>
</head>

<!-- BODYYYYYYYYY-->


<body>
<h1>
WANNABE DUNGEON KEEPER
</h1>
<div id="Game">
<script type="text/javascript">
var game = new Phaser.Game(896, 640, Phaser.CANVAS,"Game" ,{ preload: preload, create: create, update: update, render: render });

var marker;
var cursors;
var currentTrap = 0;

<!-- TileMaps Start-->
var Floormap;
var UIMap;
var CollisionMap;

<!-- TileMaps END-->
<!-- Layers Start-->

var Cavelayer;
var UILayer;
var CollisionLayer;

<!-- Layers END-->
<!-- Sprites Start-->

var enemySprite;
var happy_wall_sprite;
var Eel_Trap_Sprite;
var Bamboo_Spear_Trap_Sprite;
var Ferret_Sorcerer_Sprite;
var Goblin_Sprite;

var happy_wall_group;
var Eel_Trap_group;
var Bamboo_Spear_Trap_group;
var Ferret_Sorcerer_group;
var Goblin_Sprite_group;

<!-- Sprites END-->

var tileX = 4;
var tileY = 4;

var movementIndex = 0;

var mapOneWaypointsX = [10, 5, 5, 10, 10, 6, 6];
var mapOneWaypointsY = [6, 6, 4, 4, 1, 1, 1];

var direction = [0,3,0,1,0,3,4]; // Next valid direction 0 - North ; 1 - East ; 2 - South ; 3 - West ; 4 - Reached treasure room
var mapOneAngle = [180, 90, 180, 270, 180, 90, 90];
var mapOneMovementX = [0, -100, 0, 100, 0, -100, 0];
var mapOneMovementY = [-100, 0, -100, 0, -100, 0, 0];

var errorCheck = 0;

function preload(){
	game.load.tilemap("dirt-map","Tiles/Dirt-Map.json", null ,Phaser.Tilemap.TILED_JSON);
	game.load.tilemap("inGameUI","Tiles/Game-UI.json",null,Phaser.Tilemap.TILED_JSON);
	game.load.tilemap("CollisionTileMap","Tiles/Collision.json",null,Phaser.Tilemap.TILED_JSON);
	
	game.load.image("dirt-tiles","x64/DirtFloorSheet.png");
	game.load.image("Black-Collision","x64/Black-Collision.png")
	game.load.image("Proto-Enemy","x64/Proto-Enemy.png");
	game.load.image("UI-Left","x64/UI/Dirt-UI-Left.png");
	game.load.image("UI-Right","x64/UI/Dirt-UI-Right.png");
	
	game.load.spritesheet("Goblin","x64/Goblin.png",52,52,8);
	game.load.spritesheet("Happy-Wall","x64/HappyWallSheet.png", 64,64,12);
	game.load.spritesheet("Eel_Trap","x64/Eel-Trap-Spritesheet.png", 64,64,7);
	game.load.spritesheet("Bamboo_Spear","x64/BambooSpearTrapSheet.png", 64,64,12);
	game.load.spritesheet("Ferret_Sorcerer","x64/Ferret-Walking-SpriteSheet.png",32,32,4);

	}
	
function create(){
	/*for(i = 0;i < 10;i++){
		for(o = 0;o<10;o++){
			game.add.sprite((i*64)+80,(o*64),"dirtblock");
		}
	}*/
	game.physics.startSystem(Phaser.Physics.ARCADE);
	
	FloorMap = game.add.tilemap("dirt-map");
	UIMap = game.add.tilemap("inGameUI");
	CollisionMap = game.add.tilemap("CollisionTileMap");
	
	FloorMap.addTilesetImage("DirtFloor","dirt-tiles");
	UIMap.addTilesetImage("Dirt-UI-Left","UI-Left");
	UIMap.addTilesetImage("Dirt-UI-Right","UI-Right");
	CollisionMap.addTilesetImage("Black-Collision","Black-Collision");
//	map.addTilesetImage("Black-Collision","Black-Collision");
	
	Cavelayer = FloorMap.createLayer("Cave-Floor");
	UILayer = UIMap.createLayer("UILayer");
	

	CollisionLayer = CollisionMap.createLayer("Collisions-DirtMap1");

//	Cavelayer = MainMap.createLayer("Collisions");
	
	enemySprite = game.add.sprite(500,100,"Proto-Enemy");
	enemySprite.anchor.setTo(0.5,0.5);
	
	
	
	
//	game.camera.follow(sprite);

//	game.physics.arcade.collide(enemySprite,CollisionLayer);

	CollisionMap.setCollision(1);
	
	happy_wall_sprite = game.add.sprite((64*(tileX+1)) + 160,64*(tileY+1)-32,"Happy-Wall");
	happy_wall_sprite.anchor.setTo(0.5,0.5);
	happy_wall_sprite.angle = 0;
	happy_wall_sprite.animations.add("Wall-Smash");
	happy_wall_sprite.animations.play("Wall-Smash",15,true);

	Eel_Trap_Sprite = game.add.sprite((64*(tileX+2))+160,64*(tileY+3)-32,"Eel_Trap");
	Eel_Trap_Sprite.anchor.setTo(0.5,0.5);
	Eel_Trap_Sprite.animations.add("Idle-Trap");
	Eel_Trap_Sprite.animations.play("Idle-Trap",10,true);
	
	Bamboo_Spear_Trap_Sprite = game.add.sprite((64*(tileX + 2))+ 32,64*(tileY)+ 32,"Bamboo_Spear");
	Bamboo_Spear_Trap_Sprite.anchor.setTo(0.5,0.5);
	Bamboo_Spear_Trap_Sprite.angle = 0;
	Bamboo_Spear_Trap_Sprite.animations.add("Bamboo-Lunge");
	Bamboo_Spear_Trap_Sprite.animations.play("Bamboo-Lunge",10,true);
	
	Ferret_Sorcerer_Sprite = game.add.sprite(500,100,"Ferret_Sorcerer");
	Ferret_Sorcerer_Sprite.animations.add("Ferret_Walking");
	Ferret_Sorcerer_Sprite.anchor.setTo(0.5,0.5);
	
	Goblin_Sprite = game.add.sprite((64*11)-32,(64*10)-32,"Goblin");
	Goblin_Sprite.anchor.setTo(0.5,0.5);
	Goblin_Sprite.angle = mapOneAngle[movementIndex];
	Goblin_Sprite.scale.x = 0.8;
	Goblin_Sprite.scale.y = 0.8;
	Goblin_Sprite.animations.add("GoblinWalk", [0,1,2,3], 4, true);
	Goblin_Sprite.animations.add("GoblinSwordSwing", [4,5,6,7], 4, false);
	
	happy_wall_sprite = game.add.sprite((64*(tileX - 1)) + 32,64*(tileY + 4) + 32,"Happy-Wall");
	happy_wall_sprite.anchor.setTo(0.5,0.5);

	Bamboo_Spear_Trap_Sprite = game.add.sprite((64*(tileX + 1)) + 32 ,64*(tileY + 4) + 32,"Bamboo_Spear");
	Bamboo_Spear_Trap_Sprite.anchor.setTo(0.5,0.5);
	
	Eel_Trap_Sprite = game.add.sprite((64*(tileX + 3)) + 32 , 64*(tileY + 4) + 32,"Eel_Trap");
	Eel_Trap_Sprite.scale.x = 0.8;
	Eel_Trap_Sprite.scale.y = 0.8;
	Eel_Trap_Sprite.anchor.setTo(0.5,0.5);

	game.physics.enable(enemySprite);
	game.physics.enable(Ferret_Sorcerer_Sprite);
	game.physics.enable(Goblin_Sprite);
	
	cursors = game.input.keyboard.createCursorKeys();

    //game.input.onDown.add(fillTiles, this);
	
	marker = game.add.graphics();
	marker.lineStyle(2, 0x000000, 0.3);
	marker.drawRect(0,0, 64, 64);
	
	cursors = game.input.keyboard.createCursorKeys();
	
	happy_wall_group = game.add.group();
	Eel_Trap_group = game.add.group();
	Bamboo_Spear_Trap_group = game.add.group();
	Ferret_Sorcerer_group = game.add.group();
	Goblin_Sprite_group = game.add.group();
	
	Ferret_Sorcerer_group.add(Ferret_Sorcerer_Sprite);
	Goblin_Sprite_group.add(Goblin_Sprite);
	
}
function update()
{
	game.physics.arcade.collide(currentTrap, CollisionMap);
	
	marker.x = Cavelayer.getTileX(game.input.activePointer.worldX) * 64;
	marker.y = Cavelayer.getTileY(game.input.activePointer.worldY) * 64;
	
	if (game.input.mousePointer.isDown)
	{
		if (Cavelayer.getTileY(marker.y) == 8 && Cavelayer.getTileX(marker.x) == 3)
		{
			currentTrap = 1;
		}
		else if (Cavelayer.getTileY(marker.y) == 8 && Cavelayer.getTileX(marker.x) == 5)
		{
			currentTrap = 2;
		}
		else if (Cavelayer.getTileY(marker.y) == 8 && Cavelayer.getTileX(marker.x) == 7)
		{
			currentTrap = 3;
		}
		else
		{
			
			if(currentTrap == 1)
			{
				var happy_wall_sprite;
				happy_wall_sprite = game.add.sprite((64*(Cavelayer.getTileX(marker.x))) + 32,64*(Cavelayer.getTileY(marker.y)) + 32,"Happy-Wall");
				happy_wall_sprite.anchor.setTo(0.5,0.5);
				happy_wall_sprite.angle = 0;
				happy_wall_sprite.animations.add("Wall-Smash");
				happy_wall_group.add(happy_wall_sprite);
				//happy_wall_sprite.animations.play("Wall-Smash",15,true);
			}
			else if(currentTrap == 2)
			{
				var Bamboo_Spear_Trap_Sprite;
				Bamboo_Spear_Trap_Sprite = game.add.sprite((64*(Cavelayer.getTileX(marker.x)))+ 32,64*(Cavelayer.getTileY(marker.y))+ 32,"Bamboo_Spear")
				Bamboo_Spear_Trap_Sprite.anchor.setTo(0.5,0.5);
				Bamboo_Spear_Trap_Sprite.angle = 0;
				Bamboo_Spear_Trap_Sprite.animations.add("Bamboo-Lunge");
				Bamboo_Spear_Trap_group.add(Bamboo_Spear_Trap_Sprite);
				//Bamboo_Spear_Trap_Sprite.animations.play("Bamboo-Lunge",10,true);
			}
			else if(currentTrap == 3)
			{
				var Eel_Trap_Sprite;
				Eel_Trap_Sprite = game.add.sprite((64*(Cavelayer.getTileX(marker.x))) + 32,64*(Cavelayer.getTileY(marker.y)) + 32,"Eel_Trap");
				Eel_Trap_Sprite.anchor.setTo(0.5,0.5);
				Eel_Trap_Sprite.animations.add("Idle-Trap");
				Eel_Trap_group.add(Eel_Trap_Sprite);
				Eel_Trap_Sprite.scale.x = 0.8;
				Eel_Trap_Sprite.scale.y = 0.8;
				//Eel_Trap_Sprite.animations.play("Idle-Trap",10,true);
			}
		}
	}
	
	for(var i = 0;i<Eel_Trap_group.countLiving();i++)
	{
		for(var o = 0;o<Goblin_Sprite_group.countLiving();o++){
			if(Cavelayer.getTileX(Eel_Trap_group.getAt(i)) == Cavelayer.getTileX(Goblin_Sprite_group.getAt(o)))
			{
				Goblin_Sprite_group.getAt(o).parent.removeChild(Goblin_Sprite_group.getAt(o));	
			}
		}
		
	}

	
	
	game.physics.arcade.collide(enemySprite, CollisionLayer);
	game.physics.arcade.collide(Goblin_Sprite, CollisionLayer);

	enemySprite.body.velocity.x = 0;
	enemySprite.body.velocity.y = 0;
	enemySprite.body.angularVelocity = 0;
	 if (cursors.left.isDown)
    {
        enemySprite.body.angularVelocity = -200;
		Goblin_Sprite.animations.play("GoblinWalk",8,false);
    }
    else if (cursors.right.isDown)
    {
        enemySprite.body.angularVelocity = 200;
		Goblin_Sprite.animations.play("GoblinSwordSwing",8,false);
    }

    if (cursors.up.isDown)
    {
        enemySprite.body.velocity.copyFrom(game.physics.arcade.velocityFromAngle(enemySprite.angle, 300));
    }
	
	Goblin_Sprite.body.velocity.x = mapOneMovementX[movementIndex];
	Goblin_Sprite.body.velocity.y = mapOneMovementY[movementIndex];
	
	if(Goblin_Sprite.body.velocity.x > 0 || Goblin_Sprite.body.velocity.y > 0 || Goblin_Sprite.body.velocity.x < 0 || Goblin_Sprite.body.velocity.y < 0 )
	{
		Goblin_Sprite.animations.play("GoblinWalk",8,true);
	}
	
	if(direction[movementIndex] != 4)
	{
		checkWaypoint(Goblin_Sprite);
	}
}

function render()
{
	game.debug.text('Tile X: ' + Cavelayer.getTileX(enemySprite.x), 32, 48, 'rgb(255,255,255)');
    game.debug.text('Tile Y: ' + Cavelayer.getTileY(enemySprite.y), 32, 64, 'rgb(255,255,255)');
	
    game.debug.text('Movement: ' + movementIndex, 32, 96, 'rgb(255,255,255)');
	
    game.debug.text('Ferret X: ' + Cavelayer.getTileX(Ferret_Sorcerer_Sprite.x), 32, 112, 'rgb(255,255,255)');
    game.debug.text('Ferret Y: ' + Cavelayer.getTileY(Ferret_Sorcerer_Sprite.y), 32, 128, 'rgb(255,255,255)');
	
    game.debug.text('Speed X: ' + mapOneMovementX[movementIndex], 32, 144, 'rgb(255,255,255)');
    game.debug.text('Speed Y: ' + mapOneMovementY[movementIndex], 32, 160, 'rgb(255,255,255)');
    game.debug.text('Waypoint X: ' + mapOneWaypointsX[movementIndex], 32, 176, 'rgb(255,255,255)');
    game.debug.text('Waypoint Y: ' + mapOneWaypointsY[movementIndex], 32, 192, 'rgb(255,255,255)');
	
    game.debug.text('Sprite Direction: ' + Ferret_Sorcerer_Sprite.angle, 32, 206, 'rgb(255,255,255)');
    game.debug.text('Intended Direction: ' + mapOneAngle[movementIndex], 32, 222, 'rgb(255,255,255)');
	
    game.debug.text('F X: ' + Ferret_Sorcerer_Sprite.x, 32, 238, 'rgb(255,255,255)');
    game.debug.text('F Y: ' + Ferret_Sorcerer_Sprite.y, 32, 254, 'rgb(255,255,255)');
    game.debug.text('Pos X: ' + (mapOneWaypointsX[movementIndex] * 64 + 32), 32, 270, 'rgb(255,255,255)');
    game.debug.text('Pos Y: ' + (mapOneWaypointsY[movementIndex] * 64 + 32), 32, 286, 'rgb(255,255,255)');
    game.debug.text('Previous direction: ' + direction[movementIndex], 32, 302, 'rgb(255,255,255)');
	
	game.debug.text('Error Checkpoint: ' + errorCheck, 32, 318, 'rgb(255,255,255)');

	game.debug.text('Current trap: ' + currentTrap, 32, 334, 'rgb(255,255,255)');
}

function checkWaypoint(sprite)
{
	if(Cavelayer.getTileX(sprite.x) == mapOneWaypointsX[movementIndex])
	{
		if(Cavelayer.getTileY(sprite.y) == mapOneWaypointsY[movementIndex])
		{
			if(direction[movementIndex] == 0)
			{
				if(sprite.y <= mapOneWaypointsY[movementIndex] * 64 + 32)
				{
					movementIndex++;
					sprite.angle = mapOneAngle[movementIndex];
				}
			}
			else if(direction[movementIndex] == 1)
			{
				if(sprite.x >= mapOneWaypointsX[movementIndex] * 64 + 32)
				{
					movementIndex++;
					sprite.angle = mapOneAngle[movementIndex];
				}
			}
			else if(direction[movementIndex] == 2)
			{
				if(sprite.y >= mapOneWaypointsY[movementIndex] * 64 + 32)
				{
					movementIndex++;
					sprite.angle = mapOneAngle[movementIndex];
				}
			}
			else if(direction[movementIndex] == 3)
			{
				if(sprite.x <= mapOneWaypointsX[movementIndex] * 64 + 32)
				{
					movementIndex++;
					sprite.angle = mapOneAngle[movementIndex];
				}
			}
			else if(direction[movementIndex] == 4)
			{
				if(sprite.x <= mapOneWaypointsX[movementIndex] * 64 + 32)
				{
					movementIndex++;
					sprites.angle = mapOneAngle[movementIndex];
				}
			}
		}
	}
}


</script>
</div>








</body>
</html>
